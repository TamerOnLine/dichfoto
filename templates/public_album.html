{% extends 'layout.html' %}

{# إخفاء الهيدر لهذه الصفحة #}
{% block header_class %}hide{% endblock %}

{# 🔹 Preload للـ hero بأحجام مناسبة لكل الشاشات #}
{% if assets|length > 0 %}
  {% set hero = assets[0] %}
  {# سلاسل احتياطية مرنة: لو ما في webp/avif يرجع jpg أو thumb أو url #}
  {% set hero_480  = hero.webp_480  or hero.jpg_480  or hero.thumb or hero.url %}
  {% set hero_960  = hero.webp_960  or hero.jpg_960  or hero.thumb or hero.url %}
  {% set hero_1280 = hero.webp_1280 or hero.jpg_1280 or hero.url  or hero.thumb %}
  {% set hero_1920 = hero.webp_1920 or hero.jpg_1920 or hero_1280 %}

  {% block head %}
    <link rel="preload" as="image"
          imagesrcset="{{ hero_480 }} 480w, {{ hero_960 }} 960w, {{ hero_1280 }} 1280w, {{ hero_1920 }} 1920w"
          imagesizes="(min-width: 1920px) 1920px, (min-width: 1280px) 1280px, (min-width: 768px) 960px, 100vw">
  {% endblock %}
{% endif %}

{% block content %}

  {% if locked %}
    <section class="container">
      <p>This album is protected. Enter the password to continue.</p>
      <form action="/s/{{ share.slug }}/unlock" method="post" class="form-box">
        <label for="password">Password</label>
        <input id="password" type="password" name="password" required />
        <button class="btn" type="submit">Unlock</button>
      </form>
    </section>

  {% else %}

    {% if assets|length > 0 %}
      {% set hero = assets[0] %}
      {% set hero_480  = hero.webp_480  or hero.jpg_480  or hero.thumb or hero.url %}
      {% set hero_960  = hero.webp_960  or hero.jpg_960  or hero.thumb or hero.url %}
      {% set hero_1280 = hero.webp_1280 or hero.jpg_1280 or hero.url  or hero.thumb %}
      {% set hero_1920 = hero.webp_1920 or hero.jpg_1920 or hero_1280 %}

      <section id="hero" class="hero" style="--lqip: url('{{ hero.lqip|default('') }}');">
        <picture>
          {# AVIF (إن توفرت) #}
          {% if hero.avif_480 or hero.avif_960 or hero.avif_1280 or hero.avif_1920 %}
            <source type="image/avif"
                    srcset="{% if hero.avif_480 %}{{ hero.avif_480 }} 480w,{% endif %}
                            {% if hero.avif_960 %} {{ hero.avif_960 }} 960w,{% endif %}
                            {% if hero.avif_1280 %} {{ hero.avif_1280 }} 1280w,{% endif %}
                            {% if hero.avif_1920 %} {{ hero.avif_1920 }} 1920w{% endif %}"
                    sizes="(min-width: 1920px) 1920px, (min-width: 1280px) 1280px, (min-width: 768px) 960px, 100vw">
          {% endif %}

          {# WEBP (إن توفرت) #}
          {% if hero.webp_480 or hero.webp_960 or hero.webp_1280 or hero.webp_1920 %}
            <source type="image/webp"
                    srcset="{% if hero.webp_480 %}{{ hero.webp_480 }} 480w,{% endif %}
                            {% if hero.webp_960 %} {{ hero.webp_960 }} 960w,{% endif %}
                            {% if hero.webp_1280 %} {{ hero.webp_1280 }} 1280w,{% endif %}
                            {% if hero.webp_1920 %} {{ hero.webp_1920 }} 1920w{% endif %}"
                    sizes="(min-width: 1920px) 1920px, (min-width: 1280px) 1280px, (min-width: 768px) 960px, 100vw">
          {% endif %}

          {# JPEG fallback دائم #}
          <img class="hero-img"
               src="{{ hero_960 }}"
               srcset="{{ hero_480 }} 480w, {{ hero_960 }} 960w, {{ hero_1280 }} 1280w, {{ hero_1920 }} 1920w"
               sizes="(min-width: 1920px) 1920px, (min-width: 1280px) 1280px, (min-width: 768px) 960px, 100vw"
               alt="{{ album.title }}"
               fetchpriority="high" loading="eager" decoding="async" />
        </picture>

        <div class="hero-actions">
          <a class="icon-btn" href="/s/{{ share.slug }}/download" title="Download all">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v12m0 0 4-4m-4 4-4-4M4 21h16"
                    stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </a>
        </div>

        <div class="hero-overlay">
          <h2 class="hero-title">{{ album.title }}</h2>
        </div>
      </section>
    {% endif %}

    <div class="container">
      <div class="toolbar">
        <a class="btn" href="/s/{{ share.slug }}/download">Download all as ZIP</a>
      </div>

      {% if assets|length == 0 %}
        <p>No files available.</p>
      {% else %}
        {# شبكة الصور — السكربت يكيّف الارتفاع والمسافات حسب عرض الحاوية #}
        <div id="gallery" class="jg">
          {% for a in assets[1:] %}
            <a class="jg-item" href="{{ a.url }}" target="_blank" rel="noopener">
              <img src="{{ a.thumb }}" alt="{{ a.name }}" loading="lazy" decoding="async" />
            </a>
          {% endfor %}
        </div>
      {% endif %}
    </div>

  {% endif %}

{% endblock %}

{% block scripts %}
  <script src="/static/justified.js?v=16" defer></script>
{% endblock %}
