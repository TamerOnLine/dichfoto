{% extends 'layout.html' %}

{% block title %}{{ album.title }} â€“ {{ site_title }}{% endblock %}
{% block header_class %}hide{% endblock %}

{% block content %}

{% if locked %}
<section class="auth-wrap">
  <div class="auth-bg"></div>

  <div class="auth-card" role="dialog" aria-labelledby="auth-title" aria-describedby="auth-desc">
    <header class="auth-head">
      <!-- Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù„ÙˆØ¬Ùˆ Ø¶Ø¹Ù‡ Ù‡Ù†Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Øµ -->
      <div class="auth-brand">
        <img src="/static/logo.svg" alt="Dich Foto" onerror="this.replaceWith(document.createTextNode('Dich Foto'))">
      </div>

      <h1 id="auth-title" class="auth-title serif">{{ album.title }}</h1>
      <p id="auth-desc" class="auth-desc">
        This album is protected â€” enter the password to continue.
      </p>
    </header>

    {% if error %}
      <div class="auth-alert" role="alert" aria-live="polite">
        Incorrect password. Please try again.
      </div>
    {% endif %}

    <form action="/s/{{ share.slug }}/unlock" method="post" class="auth-form" novalidate>
      <label class="auth-label" for="password">Password</label>

      <div class="auth-input-wrap">
        <input id="password" name="password" type="password" required
               autocomplete="current-password" class="auth-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
               aria-describedby="auth-desc" />
        <button type="button" class="auth-eye" aria-label="Show password" aria-pressed="false">ğŸ‘</button>
      </div>

      <button class="auth-btn" type="submit" data-loading="Unlockingâ€¦">
        Unlock
      </button>
    </form>


  </div>
</section>
{% else %}




  <!-- Ø§Ù„ØºÙ„Ø§Ù Ø¨Ù†Ø³Ø¨Ø© 90% Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© -->
  <section class="hero" aria-label="Cover">
    {% if hero %}
      <a class="hero-link" href="{{ hero.url }}" target="_blank" rel="noopener">
        <img
          class="hero-img"
          src="{{ hero.thumb }}"
          alt="{{ album.title }}"
          fetchpriority="high" loading="eager" decoding="async"
          {% if hero.width and hero.height %}width="{{ hero.width }}" height="{{ hero.height }}"{% endif %}
        />
      </a>

      <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„ØµÙˆØ±Ø© -->
      <div class="hero-overlay">
        <div class="hero-meta">
          {% if album.event_date %}
            <p class="hero-date">{{ album.event_date.strftime('%d.%m.%Y') }}</p>
          {% endif %}

          <h1 class="hero-title serif">{{ album.title }}</h1>

          {% if album.photographer %}
            <p class="hero-sub">
              Wedding photographer
              {% if album.photographer_url %}
                <a href="{{ album.photographer_url }}" target="_blank" rel="noopener">
                  {{ album.photographer }}
                </a>
              {% else %}
                {{ album.photographer }}
              {% endif %}
            </p>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="hero-empty">
        <h1 class="hero-title serif">{{ album.title }}</h1>
        <p class="hero-sub">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</p>
      </div>
    {% endif %}
  </section>

  <!-- Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ø´Ù„Ø§Ù„) -->
  <section id="gallery" class="gallery">
    <div class="masonry"
        style="
          --gap:4px;
          --cols-0:2;
          --cols-480:2;
          --cols-640:3;
          --cols-900:3;
          --cols-1200:5;
          --cols-1600:6;
        ">
      {% for a in assets %}
        <figure class="card">
          <a href="{{ a.url }}"
             data-full="{{ a.url }}"
             data-name="{{ a.original_name or a.name }}">
            <img
              src="{{ a.thumb }}"
              alt="{{ a.name or album.title }}"
              loading="lazy" decoding="async"
              {% if a.width and a.height %}width="{{ a.width }}" height="{{ a.height }}"{% endif %}
            />
          </a>
        </figure>
      {% endfor %}
    </div>
  </section>

{% endif %}

{% endblock %}

{% block scripts_extra %}
<style>
  .serif{ font-family: Georgia, "Times New Roman", Times, serif; }

  /* Ø§Ù„Ø­Ø§ÙˆÙŠØ©: Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ ØªÙˆØ³ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù…ÙˆØ¯ÙŠÙ‹Ø§ */
  .hero{
    position: relative;
    width: 100%;
    min-height: 100vh;
    min-height: 100svh;      /* Ø£ÙØ¶Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    background:#000;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:1px;
    padding:20px 0;
  }

  /* Ø§Ù„ØµÙˆØ±Ø©: 90% Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©ØŒ ÙˆØ§Ù„Ø·ÙˆÙ„ ÙŠØªÙƒÙŠÙ Ø¨Ø¯ÙˆÙ† Ù‚Øµ */
  .hero-img{
    width: 90%;
    height: auto;
    max-height: 85vh;        /* ÙŠÙ…Ù†Ø¹ ØªØ¬Ø§ÙˆØ² Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© */
    object-fit: contain;
    display: block;
    border-radius: 12px;
    box-shadow: 0 6px 24px rgba(0,0,0,.45);
  }

  /* Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨Ù„ÙˆÙƒ Ø¹Ø§Ø¯ÙŠ */
  .hero-overlay{
    width: 90%;
    max-width: 1100px;
    text-align: center;
    color:#fff;
    padding: 0;
    background: none;
  }

  .hero-date{
    margin: 0 0 6px;
    font-size: clamp(12px, 2.8vw, 18px);
    color:#e5e7eb;
    text-shadow: 0 2px 8px rgba(0,0,0,.45);
  }

  .hero-title{
    margin: 0 0 8px;
    font-weight: 600;
    line-height: .95;
    font-size: clamp(28px, 6vw, 60px);
    text-shadow: 0 4px 18px rgba(0,0,0,.35);
  }

  .hero-sub{
    margin: 0;
    font-size: clamp(14px, 3.2vw, 20px);
    color:#f1f5f9;
    text-shadow: 0 2px 8px rgba(0,0,0,.35);
  }
  .hero-sub a{
    color:#fff; text-decoration: underline; text-underline-offset: 3px;
  }

  /* Ø³Ø¨Ù†Ø± Ø§Ù„Ù„Ø§ÙŠØªØ¨ÙˆÙƒØ³ */
  .lb-spin[hidden]{ display: none !important; }

  /* ØªÙ…ÙŠÙŠØ² Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
  .lb-like.liked{ color:#ff4d6d; transform: scale(1.2); transition: transform .2s ease; }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const links = Array.from(document.querySelectorAll(".masonry a[data-full]"));
  if (!links.length) return;

  const wrap = document.createElement("div");
  wrap.id = "lightbox";
  wrap.innerHTML = `
    <div class="lb-stage">
      <div class="lb-spin" hidden></div>
      <img class="lb-img" alt="" />
      <div class="lb-cap"></div>
      <button class="lb-btn lb-prev" aria-label="Previous">â®</button>
      <button class="lb-btn lb-next" aria-label="Next">â¯</button>
      <button class="lb-btn lb-close" aria-label="Close">âœ•</button>

      <!-- Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
      <a class="lb-btn lb-download"
         aria-label="Download"
         href="#"
         download
         rel="noopener"
         style="top:auto; bottom: clamp(8px, 1.2vw, 16px); left: clamp(8px, 1.2vw, 16px); transform:none;">
        â¬‡
      </a>

      <!-- Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© -->
      <button class="lb-btn lb-share" aria-label="Share"
        style="top:auto; bottom: clamp(8px, 1.2vw, 16px); right: clamp(60px, 4vw, 80px); transform:none;">
        â¤´
      </button>

      <!-- Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ -->
      <button class="lb-btn lb-like" aria-label="Like"
        style="top:auto; bottom: clamp(8px, 1.2vw, 16px); left: clamp(60px, 4vw, 80px); transform:none;">
        â¤
      </button>

      <div class="lb-swipe-hint">Swipe left/right</div>
    </div>
  `;
  document.body.appendChild(wrap);

  const img         = wrap.querySelector(".lb-img");
  const cap         = wrap.querySelector(".lb-cap");
  const spin        = wrap.querySelector(".lb-spin");
  const btnPrev     = wrap.querySelector(".lb-prev");
  const btnNext     = wrap.querySelector(".lb-next");
  const btnClose    = wrap.querySelector(".lb-close");
  const btnLike     = wrap.querySelector(".lb-like");
  const btnShare    = wrap.querySelector(".lb-share");
  const btnDownload = wrap.querySelector(".lb-download");

  // === ØªØ®Ø²ÙŠÙ† Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„ÙƒÙ„ ØµÙˆØ±Ø©) ===
  const likedStoreKey = "dichfoto_likes";
  const liked = new Set(JSON.parse(localStorage.getItem(likedStoreKey) || "[]"));
  function saveLikes() {
    localStorage.setItem(likedStoreKey, JSON.stringify([...liked]));
  }

  let idx = 0;

  function makeFilename(fullUrl, humanName, index){
    try{
      const u = new URL(fullUrl, window.location.origin);
      const ext = u.pathname.split(".").pop()?.toLowerCase();
      const base = (humanName || `photo-${index+1}`).trim()
        .replace(/[^\p{L}\p{N}\-_ ]/gu, "")
        .replace(/\s+/g, "-");
      if (ext && ext.length <= 5) return `${base}.${ext}`;
      return `${base}.jpg`;
    }catch{
      return `${humanName || "photo"}-${index+1}.jpg`;
    }
  }

  function show(i){
    idx = (i + links.length) % links.length;
    const a    = links[idx];
    const full = a.dataset.full || a.href;
    const alt  = a.querySelector("img")?.getAttribute("alt") || "";
    const name = (a.getAttribute("data-name") || alt || `photo-${idx+1}`).trim();

    document.body.classList.add("no-scroll");
    wrap.classList.add("show");
    img.classList.remove("ready");
    spin.hidden = false;

    // Ø­Ø¯Ù‘Ø« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ø­Ø³Ø¨ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©
    const isLiked = liked.has(full);
    btnLike.classList.toggle("liked", isLiked);
    btnLike.setAttribute("aria-pressed", isLiked ? "true" : "false");

    // Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
    const onImgLoad = () => {
      img.removeEventListener("load", onImgLoad);
      img.classList.add("ready");
      spin.hidden = true;
      cap.textContent = alt;

      // ØªØ¬Ù‡ÙŠØ² Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø§Ù„Ø±Ø§Ø¨Ø· + Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù)
      btnDownload.href = full;
      btnDownload.setAttribute("download", makeFilename(full, name, idx));
    };
    img.addEventListener("load", onImgLoad, { once: true });

    // ØªØ­Ù…ÙŠÙ„ Ù…ÙØ³Ø¨Ù‚ Ø«Ù… Ø§Ù„Ø¹Ø±Ø¶
    const preload = new Image();
    preload.onload = () => {
      img.src = preload.src;
      img.alt = alt;

      // ØªØ­Ù…ÙŠÙ„ Ù…ÙØ³Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©
      new Image().src = (links[(idx+1)%links.length].dataset.full || links[(idx+1)%links.length].href);
      new Image().src = (links[(idx-1+links.length)%links.length].dataset.full || links[(idx-1+links.length)%links.length].href);
    };
    preload.onerror = () => {
      cap.textContent = "Failed to load image";
      spin.hidden = true;
    };
    preload.src = full;
  }

  function close(){
    wrap.classList.remove("show");
    document.body.classList.remove("no-scroll");
  }

  // ØªÙ†Ù‚Ù‘Ù„ Ùˆ Ø¥ØºÙ„Ø§Ù‚
  btnPrev.addEventListener("click", () => show(idx-1));
  btnNext.addEventListener("click", () => show(idx+1));
  btnClose.addEventListener("click", close);
  wrap.addEventListener("click", (e) => { if (e.target === wrap) close(); });

  // ÙƒÙŠØ¨ÙˆØ±Ø¯
  document.addEventListener("keydown", (e) => {
    if (!wrap.classList.contains("show")) return;
    if (e.key === "Escape") close();
    if (e.key === "ArrowLeft") show(idx-1);
    if (e.key === "ArrowRight") show(idx+1);
  });

  // ÙØªØ­ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©
  links.forEach((a, i) => {
    a.addEventListener("click", (e) => { e.preventDefault(); show(i); });
  });

  // Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ (Ù„ÙƒÙ„ ØµÙˆØ±Ø©)
  btnLike.addEventListener("click", () => {
    const a = links[idx];
    const full = a.dataset.full || a.href;
    if (liked.has(full)) {
      liked.delete(full);
      btnLike.classList.remove("liked");
      btnLike.setAttribute("aria-pressed", "false");
    } else {
      liked.add(full);
      btnLike.classList.add("liked");
      btnLike.setAttribute("aria-pressed", "true");
    }
    saveLikes();

    // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø£Ø±Ø³Ù„ Ù„Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯
    fetch("/api/like", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ url: full, liked: btnLike.classList.contains("liked") })
    }).catch(err => console.log("Like failed:", err));
  });

  // Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
  btnShare.addEventListener("click", async () => {
    const full = links[idx].dataset.full || links[idx].href;
    const alt  = links[idx].querySelector("img")?.getAttribute("alt") || "";
    if (navigator.share) {
      try {
        await navigator.share({ title: alt || document.title, text: alt || "Check this photo", url: full });
      } catch (err) { console.log("Share canceled or failed:", err); }
    } else {
      try { await navigator.clipboard.writeText(full); alert("Link copied to clipboard!"); }
      catch { alert(full); }
    }
  });

  // Swipe Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
  let sx=0, sy=0, dx=0, dy=0, swiping=false;
  wrap.addEventListener("touchstart", (e) => {
    const t=e.touches[0]; sx=t.clientX; sy=t.clientY; swiping=true;
  }, {passive:true});
  wrap.addEventListener("touchmove", (e) => {
    if(!swiping) return; const t=e.touches[0]; dx=t.clientX-sx; dy=t.clientY-sy;
  }, {passive:true});
  wrap.addEventListener("touchend", () => {
    if(!swiping) return; swiping=false;
    if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) show(idx+1); else show(idx-1);
    }
    dx=dy=0;
  });
});
</script>
{% endblock %}
